{% extends "base.html" %}
{% load static %}

{% block title %}Vigenère Cipher | AlgoVault{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'css/vigenere.css' %}">
{% endblock %}

{% block content %}
<section class="hero" id="home">
    <div class="container">
        <h1>Vigenère Cipher Solution</h1>
        <p>Secure your sensitive communications with military-grade Vigenère cipher encryption. Our enterprise solution provides advanced encryption and decryption capabilities with comprehensive security controls and audit capabilities.</p>
    </div>
</section>

<main class="main container" id="tools">
    <div class="notification success" id="notification"></div>
    
    <section class="cipher-section">
        <h2 class="section-title">Vigenère Cipher Tool</h2>
        
        <div class="input-group">
            <label for="message">Message</label>
            <textarea id="message" placeholder="Enter your message here..."></textarea>
        </div>
        
        <div class="input-row">
            <div class="input-group">
                <label for="keyword">Keyword (letters only)</label>
                <input type="text" id="keyword" placeholder="Enter a keyword (e.g., KEY)" value="KEY">
            </div>
            
            <div class="input-group">
                <label for="operation">Operation</label>
                <select id="operation">
                    <option value="encrypt">Encrypt</option>
                    <option value="decrypt">Decrypt</option>
                    <option value="brute-force">Brute Force Analysis</option>
                </select>
            </div>
        </div>
        
        <div class="input-group" id="advanced-options" style="display: none;">
            <label for="analysis-method">Analysis Method</label>
            <select id="analysis-method">
                <option value="frequency">Letter Frequency Analysis</option>
                <option value="all-shifts">All Possible Shifts</option>
            </select>
        </div>
        
        <div class="btn-group">
            <button id="process-btn" class="btn tooltip">
                <span class="btn-text">Process</span>
                <span class="btn-icon"><i class="fas fa-cog"></i></span>
                <span class="tooltiptext">Run the cipher operation</span>
            </button>
            <button id="clear-btn" class="btn btn-secondary tooltip">
                <span class="btn-text">Clear</span>
                <span class="btn-icon"><i class="fas fa-eraser"></i></span>
                <span class="tooltiptext">Reset all fields</span>
            </button>
        </div>
        
        <div class="result-section" id="result-section">
            <h3>Result</h3>
            <div class="result-box" id="result-output"></div>
            <button id="copy-btn" class="btn btn-accent copy-btn tooltip">
                <i class="fas fa-copy"></i> Copy to Clipboard
                <span class="tooltiptext">Copy result to clipboard</span>
            </button>
        </div>
        
        <div class="shift-visualization" id="vigenere-visualization" style="display:none;">
            <h3>Vigenère Cipher Process Visualization</h3>
            <p class="visualization-guide">Watch how the Vigenère cipher transforms your input through multiple processing stages.</p>

            <!-- Step 1: Keyword Analysis -->
            <div class="hash-step" id="step-1">
                <div class="step-header">
                    <div class="step-number">1</div>
                    <h4>Keyword Analysis</h4>
                    <div class="step-status" id="step-1-status">⏳ Waiting</div>
                </div>
                <div class="step-content">
                    <div class="input-breakdown">
                        <div class="data-label">Keyword:</div>
                        <div id="keyword-display" class="data-display">Enter a keyword to see analysis</div>
                    </div>
                    <div class="input-breakdown">
                        <div class="data-label">Keyword Length:</div>
                        <div id="keyword-length" class="data-display">-</div>
                    </div>
                    <div class="input-breakdown">
                        <div class="data-label">Keyword Pattern:</div>
                        <div id="keyword-pattern" class="data-display pattern-text">Pattern will appear here</div>
                    </div>
                </div>
            </div>

            <!-- Process Arrow -->
            <div class="process-arrow">
                <div class="arrow-line"></div>
                <i class="fas fa-arrow-down"></i>
            </div>

            <!-- Step 2: Input Processing -->
            <div class="hash-step" id="step-2">
                <div class="step-header">
                    <div class="step-number">2</div>
                    <h4>Input Processing</h4>
                    <div class="step-status" id="step-2-status">⏳ Waiting</div>
                </div>
                <div class="step-content">
                    <div class="input-breakdown">
                        <div class="data-label">Original Message:</div>
                        <div id="original-message" class="data-display">Enter text to see breakdown</div>
                    </div>
                    <div class="input-breakdown">
                        <div class="data-label">Cleaned Input (A-Z only):</div>
                        <div id="cleaned-input" class="data-display">Cleaned text will appear here</div>
                    </div>
                    <div class="input-breakdown">
                        <div class="data-label">Message Length:</div>
                        <div id="message-length" class="data-display">-</div>
                    </div>
                </div>
            </div>

            <!-- Process Arrow -->
            <div class="process-arrow">
                <div class="arrow-line"></div>
                <i class="fas fa-arrow-down"></i>
            </div>

            <!-- Step 3: Character Mapping -->
            <div class="hash-step" id="step-3">
                <div class="step-header">
                    <div class="step-number">3</div>
                    <h4>Character-by-Character Mapping</h4>
                    <div class="step-status" id="step-3-status">⏳ Waiting</div>
                </div>
                <div class="step-content">
                    <div class="mapping-grid" id="mapping-grid">
                        <div class="mapping-info">Processing character mappings...</div>
                    </div>
                    <div class="current-mapping">
                        <div class="mapping-label">Current Mapping:</div>
                        <div id="current-char-mapping" class="mapping-display">-</div>
                    </div>
                </div>
            </div>

            <!-- Process Arrow -->
            <div class="process-arrow">
                <div class="arrow-line"></div>
                <i class="fas fa-arrow-down"></i>
            </div>

            <!-- Step 4: Final Result -->
            <div class="hash-step" id="step-4">
                <div class="step-header">
                    <div class="step-number">4</div>
                    <h4>Final Result</h4>
                    <div class="step-status" id="step-4-status">⏳ Waiting</div>
                </div>
                <div class="step-content">
                    <div class="input-breakdown">
                        <div class="data-label">Operation:</div>
                        <div id="operation-display" class="data-display">-</div>
                    </div>
                    <div class="input-breakdown">
                        <div class="data-label">Final Output:</div>
                        <div id="final-output" class="data-display result-text">Result will appear here</div>
                    </div>
                </div>
            </div>
        </div>
    </section>
    
    <!-- ========= NEW: Feature Cards for Vigenère Cipher ========= -->
    <div class="features">
        <div class="feature-card">
            <div class="feature-icon"><i class="fas fa-layer-group"></i></div>
            <h3 class="feature-title">Polyalphabetic Substitution</h3>
            <p>Uses multiple Caesar ciphers in sequence, determined by a keyword, to add layers of complexity.</p>
        </div>
        <div class="feature-card">
            <div class="feature-icon"><i class="fas fa-key"></i></div>
            <h3 class="feature-title">Keyword-Driven Security</h3>
            <p>The secret keyword is repeated to create a key stream, with each letter determining the shift for the corresponding plaintext letter.</p>
        </div>
        <div class="feature-card">
            <div class="feature-icon"><i class="fas fa-shield-alt"></i></div>
            <h3 class="feature-title">Defeats Frequency Analysis</h3>
            <p>By using multiple alphabets, it flattens letter frequency distribution, making it immune to simple frequency analysis attacks.</p>
        </div>
        <div class="feature-card">
            <div class="feature-icon"><i class="fas fa-table"></i></div>
            <h3 class="feature-title">Vigenère Square</h3>
            <p>The cipher is based on the Vigenère square (or tableau), a 26x26 grid of all possible Caesar cipher shifts.</p>
        </div>
        <div class="feature-card">
            <div class="feature-icon"><i class="fas fa-landmark"></i></div>
            <h3 class="feature-title">Historically Significant</h3>
            <p>Famously known as "le chiffre indéchiffrable" (the indecipherable cipher) for centuries due to its advanced design.</p>
        </div>
        <div class="feature-card">
            <div class="feature-icon"><i class="fas fa-search"></i></div>
            <h3 class="feature-title">Classic Cryptanalysis Target</h3>
            <p>While strong, it's vulnerable to advanced techniques like the Kasiski examination, which can determine the keyword length.</p>
        </div>
    </div>
    
    <!-- ========= NEW: About and How-to-Use Sections ========= -->
    <section class="info-section" id="about">
        <h2 class="section-title">About the Vigenère Cipher</h2>
        <div class="info-content">
            <div class="info-text">
                <p>The Vigenère Cipher is a classical polyalphabetic substitution cipher that improves upon the Caesar cipher by using a keyword to apply a series of Caesar shifts. Each letter of the plaintext is encrypted using a different Caesar shift based on the corresponding letter of the keyword, which makes frequency analysis more difficult. Although commonly attributed to Blaise de Vigenère, the cipher was first described in 1553 by Giovan Battista Bellaso.</p>
                <br>
                <p>For centuries, it was known as "le chiffre indéchiffrable" (the indecipherable cipher) due to its ability to obscure letter frequency patterns. However, it can be cracked using cryptanalytic methods like the Kasiski examination or the Friedman test, which help determine the key length. Once the key length is found, the ciphertext can be split into segments and solved as multiple Caesar ciphers. Despite its vulnerabilities today, the Vigenère cipher remains an important milestone in the history of cryptography.</p>
                <br>
                <p>Despite being vulnerable to modern attacks, the Vigenère cipher remains a cornerstone in the history of cryptography. It represents a major step forward from simple ciphers and introduced the concept of using multiple substitution alphabets to improve security. Today, it is often used as a teaching tool to demonstrate how combining simple encryption methods can significantly strengthen a cipher, even if it’s not secure by today’s standards.</p>
            </div>
            <div class="info-image">
                <img src="https://miro.medium.com/v2/resize:fit:4800/format:webp/1*SzqMm5ZhXyLAvYkLhGIedA.png" alt="Vigenère Cipher Table">
            </div>
        </div>
    </section>

    <section class="info-section" id="help">
        <h2 class="section-title">How to Use</h2>
        <div class="info-content">
            <div class="info-text">
                <ol>
                    <li><strong>Enter Your Message:</strong> Type or paste the text you wish to process in the main text area.</li>
                    <li><strong>Provide a Keyword:</strong> Enter a secret keyword using only alphabetic characters (A-Z). This word is the key to the cipher.</li>
                    <li><strong>Select Operation:</strong> Choose whether to "Encrypt" your message or "Decrypt" an existing ciphertext.</li>
                    <li><strong>Process:</strong> Click the "Process" button to perform the Vigenère cipher operation.</li>
                    <li><strong>View and Copy Result:</strong> The resulting text will appear in the output box. Use the copy button for convenience.</li>
                </ol>
                <br>
                <p><strong>Note:</strong> This implementation ignores all numbers, spaces, and symbols, processing only the alphabetic characters of your message.</p>
            </div>
        </div>
    </section>
    </section>

    
</main>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- Elements ---
    const messageInput = document.getElementById('message');
    const keywordInput = document.getElementById('keyword');
    const operationSelect = document.getElementById('operation');
    const processBtn = document.getElementById('process-btn');
    const resultOutput = document.getElementById('result-output');
    const resultSection = document.getElementById('result-section');
    // ... (add other element selectors if needed)

    // Helper function to get the CSRF token from cookies
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    // --- New Step-by-Step Visualization Logic ---
    const vigenereVisualization = document.getElementById('vigenere-visualization');

    function initializeVigenereVisualization() {
        updateStepByStepDisplay();
    }

    function updateStepByStepDisplay() {
        const keyword = keywordInput.value.toUpperCase() || 'KEY';
        const message = messageInput.value;
        
        // Update Step 1: Keyword Analysis
        document.getElementById('keyword-display').textContent = keyword;
        document.getElementById('keyword-length').textContent = keyword.length;
        
        // Create keyword pattern
        const cleanedMessage = message.toUpperCase().replace(/[^A-Z]/g, '');
        let patternText = '';
        for (let i = 0; i < Math.min(cleanedMessage.length, 20); i++) {
            patternText += keyword[i % keyword.length];
            if (i < Math.min(cleanedMessage.length, 20) - 1) patternText += ' ';
        }
        if (cleanedMessage.length > 20) patternText += '...';
        document.getElementById('keyword-pattern').textContent = patternText || 'Pattern will appear here';

        // Update Step 2: Input Processing
        document.getElementById('original-message').textContent = message || 'Enter text to see breakdown';
        document.getElementById('cleaned-input').textContent = cleanedMessage || 'Cleaned text will appear here';
        document.getElementById('message-length').textContent = cleanedMessage.length || '-';

        // Update step status based on content
        updateStepStatus('step-1', keyword ? 'ready' : 'waiting');
        updateStepStatus('step-2', message ? 'ready' : 'waiting');
    }

    function updateStepStatus(stepId, status) {
        const statusElement = document.getElementById(stepId + '-status');
        switch(status) {
            case 'waiting':
                statusElement.textContent = '⏳ Waiting';
                statusElement.className = 'step-status waiting';
                break;
            case 'ready':
                statusElement.textContent = '✅ Ready';
                statusElement.className = 'step-status ready';
                break;
            case 'processing':
                statusElement.textContent = '⚡ Processing';
                statusElement.className = 'step-status processing';
                break;
            case 'complete':
                statusElement.textContent = '✅ Complete';
                statusElement.className = 'step-status complete';
                break;
        }
    }

    function showVisualizationStep(stepNumber) {
        vigenereVisualization.style.display = 'block';
        vigenereVisualization.scrollIntoView({ behavior: 'smooth' });
        
        // Animate step appearance
        const step = document.getElementById(`step-${stepNumber}`);
        if (step) {
            step.style.animation = 'stepAppear 0.5s ease-in-out';
        }
    }

    function updateCharacterMappingGrid(inputText, outputText) {
        const mappingGrid = document.getElementById('mapping-grid');
        
        if (!inputText || !outputText) {
            mappingGrid.innerHTML = '<div class="mapping-info">Processing character mappings...</div>';
            return;
        }

        const keyword = keywordInput.value.toUpperCase() || 'KEY';
        const operation = operationSelect.value;
        
        const cleanInput = inputText.toUpperCase().replace(/[^A-Z]/g, '');
        const cleanOutput = outputText.toUpperCase().replace(/[^A-Z]/g, '');
        
        mappingGrid.innerHTML = '';
        
        // Create mapping table
        const table = document.createElement('div');
        table.className = 'mapping-table';
        
        // Header
        const header = document.createElement('div');
        header.className = 'mapping-row mapping-header';
        header.innerHTML = `
            <div class="mapping-cell">Position</div>
            <div class="mapping-cell">Input</div>
            <div class="mapping-cell">Key</div>
            <div class="mapping-cell">Operation</div>
            <div class="mapping-cell">Output</div>
        `;
        table.appendChild(header);
        
        // Data rows (limit to first 10 for display)
        const displayLimit = Math.min(10, cleanInput.length, cleanOutput.length);
        for (let i = 0; i < displayLimit; i++) {
            const keyChar = keyword[i % keyword.length];
            const inputChar = cleanInput[i];
            const outputChar = cleanOutput[i];
            const shift = keyChar.charCodeAt(0) - 65;
            
            const row = document.createElement('div');
            row.className = 'mapping-row';
            row.innerHTML = `
                <div class="mapping-cell">${i + 1}</div>
                <div class="mapping-cell input-char">${inputChar}</div>
                <div class="mapping-cell key-char">${keyChar} (${shift})</div>
                <div class="mapping-cell operation">${operation === 'encrypt' ? '+' : '-'}</div>
                <div class="mapping-cell output-char">${outputChar}</div>
            `;
            table.appendChild(row);
            
            // Animate row appearance
            setTimeout(() => {
                row.style.animation = 'fadeInRow 0.3s ease-in-out';
            }, i * 100);
        }
        
        if (cleanInput.length > displayLimit) {
            const moreRow = document.createElement('div');
            moreRow.className = 'mapping-row more-row';
            moreRow.innerHTML = `<div class="mapping-cell" colspan="5">... and ${cleanInput.length - displayLimit} more characters</div>`;
            table.appendChild(moreRow);
        }
        
        mappingGrid.appendChild(table);
    }

    // Update visualization on input changes
    keywordInput.addEventListener('input', updateStepByStepDisplay);
    messageInput.addEventListener('input', updateStepByStepDisplay);
    
    // Initialize on page load
    initializeVigenereVisualization();

    // --- Main Processing Function ---
    async function processVigenere() {
        const message = messageInput.value;
        const keyword = keywordInput.value;
        const operation = operationSelect.value;

        if (!message || !keyword) {
            showNotification('Please enter a message and keyword.', 'error');
            return;
        }

        // Display a loading state on the button
        processBtn.disabled = true;
        processBtn.innerHTML = '<span class="btn-text">Processing...</span><i class="fas fa-spinner fa-spin"></i>';

        try {
            // Send data to the Django API endpoint
            const response = await fetch('/api/vigenere/process/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    // Note: If you use @csrf_exempt, you might not need this token.
                    // But it's good practice to include it for future security.
                    'X-CSRFToken': csrftoken 
                },
                body: JSON.stringify({
                    message: message,
                    keyword: keyword,
                    operation: operation
                })
            });

            const data = await response.json();

            if (!response.ok) {
                // Handle errors returned from the backend
                throw new Error(data.error || 'An unknown error occurred.');
            }

            // Display the result from the backend
            resultOutput.textContent = data.result;
            resultSection.style.display = 'block';
            resultSection.scrollIntoView({ behavior: 'smooth' });

            // Update step-by-step visualization
            updateStepStatus('step-1', 'complete');
            updateStepStatus('step-2', 'complete');
            updateStepStatus('step-3', 'processing');
            
            showVisualizationStep(3);
            updateCharacterMappingGrid(message, data.result);
            
            setTimeout(() => {
                updateStepStatus('step-3', 'complete');
                updateStepStatus('step-4', 'processing');
                
                // Update Step 4: Final Result
                document.getElementById('operation-display').textContent = operation.charAt(0).toUpperCase() + operation.slice(1);
                document.getElementById('final-output').textContent = data.result;
                
                setTimeout(() => {
                    updateStepStatus('step-4', 'complete');
                }, 500);
            }, 1000);

        } catch (error) {
            showNotification(`Error: ${error.message}`, 'error');
            resultOutput.textContent = '';
            resultSection.style.display = 'none';
        } finally {
            // Restore the button to its original state
            processBtn.disabled = false;
            processBtn.innerHTML = '<span class="btn-text">Process</span><span class="btn-icon"><i class="fas fa-cog"></i></span>';
        }
    }

    // --- Event Listeners ---
    processBtn.addEventListener('click', processVigenere);

    // ... (Keep your other event listeners for clearBtn, copyBtn, etc.)
    // For example:
    document.getElementById('clear-btn').addEventListener('click', () => {
        messageInput.value = '';
        keywordInput.value = 'KEY';
        resultOutput.textContent = '';
        resultSection.style.display = 'none';
    });
    
    document.getElementById('copy-btn').addEventListener('click', () => {
        if (!resultOutput.textContent) return;
        navigator.clipboard.writeText(resultOutput.textContent)
            .then(() => showNotification('Result copied to clipboard!', 'success'))
            .catch(() => showNotification('Failed to copy text.', 'error'));
    });
    
    // You need a showNotification function, likely in your base.html
    function showNotification(message, type) {
        const notification = document.getElementById('notification');
        if (!notification) return;
        notification.textContent = message;
        notification.className = 'notification ' + type;
        notification.style.display = 'block';
        setTimeout(() => {
            notification.style.display = 'none';
        }, 3000);
    }
});
</script>
{% endblock %}
